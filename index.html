<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>81宮格（行業＋分會＋十色亮燈＋九區淡底色）— 修正版</title>
<style>
  :root{
    --gap:6px; --radius:10px; --border:#ced4da;
    --b0:#fff0f0; --b1:#fff7db; --b2:#eefce9;
    --b3:#e8f9ff; --b4:#f3f3f3; --b5:#f2ecff;
    --b6:#fff3e6; --b7:#e8f2ff; --b8:#fde5f0;
  }
  body{ margin:0; background:#f8f9fa; font-family:sans-serif; padding:16px; display:flex; flex-direction:column; align-items:center; }
  .bar{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px; }
  input, button{ padding:6px 10px; border:1px solid var(--border); border-radius:8px; font-size:14px; }
  button{ cursor:pointer; background:#fff; }
  .grid{ display:grid; grid-template-columns:repeat(9,1fr); gap:var(--gap); width:min(95vmin,800px); }
  .cell{ border:2px solid var(--border); border-radius:var(--radius); aspect-ratio:1/1; display:flex; align-items:center; justify-content:center; cursor:pointer; position:relative; }
  .cell .label{ padding:4px; text-align:center; font-size:clamp(10px,1.5vmin,16px); font-weight:600; word-break:break-word; z-index:1; }
  .drawer{ position:fixed; right:20px; top:20px; width:320px; background:#fff; border:1px solid var(--border); border-radius:10px; padding:12px; display:none; flex-direction:column; gap:6px; }
  .drawer.open{ display:flex; }
  .colors{ display:flex; flex-wrap:wrap; gap:4px; }
  .color-btn{ width:24px; height:24px; border-radius:6px; border:1px solid #ccc; cursor:pointer; }
  .hint{ font-size:13px; color:#495057; background:#fff; border:1px dashed #ced4da; border-radius:10px; padding:10px 12px; margin-bottom:12px; max-width:820px;}
  .muted{ color:#6c757d; font-size:12px; }
  .status{ margin-top:8px; min-height:20px; font-size:13px; color:#343a40; }
  @media print{
    .bar, .drawer, .hint, .status{ display:none !important; }
    body{ padding:0; }
    .grid{ gap:4px; }
    @page{ size:A4 portrait; margin:10mm; }
  }
</style>
</head>
<body>
  <h2>81宮格（整頁行業＋分會＋十色亮燈＋九區淡底色）</h2>

  <div class="hint">
    <strong>使用說明：</strong><br/>
    1) <u>行業別可能重複</u>，<b>搜尋一定要同時輸入「行業別＋分會」</b> 才能正確找到對應頁面。<br/>
    2) 存檔時請填入「文件ID」。若未填，系統會自動產生唯一 ID（不會覆蓋上一份）。<br/>
    3) 若點「載入」，會用輸入框內的「文件ID」載入那一份資料。<br/>
    <span class="muted">小提醒：若 Firestore 要求建立索引，依提示建立即可（等數分鐘生效）。</span>
  </div>

  <div class="bar">
    <input id="industry" placeholder="行業別" />
    <input id="chapter" placeholder="分會" />
    <input id="docId" placeholder="文件ID" />
    <button id="saveBtn">存檔</button>
    <button id="loadBtn">載入</button>
    <button id="searchBtn">搜尋</button>
    <button onclick="window.print()">匯出PDF</button>
  </div>

  <div class="grid" id="grid"></div>
  <div class="status" id="status"></div>

  <div class="drawer" id="drawer">
    <h3>編輯格子 <span id="cellIndex"></span></h3>
    <textarea id="cellText" rows="4" placeholder="輸入內容"></textarea>
    <div class="colors" id="colorPicker"></div>
    <button id="clearColorBtn">清除顏色</button>
    <button id="okBtn">確定</button>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {"apiKey": "AIzaSyBxiSxwkh4TT8X0p-meD-qHXShiiJ0NDV8", "authDomain": "grid-b24fa.firebaseapp.com", "projectId": "grid-b24fa", "storageBucket": "grid-b24fa.firebasestorage.app", "messagingSenderId": "43132292109", "appId": "1:43132292109:web:264e8601897712f0109944", "measurementId": "G-ZCX79SMRJE"};
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let meta = { industry:"", chapter:"" };
  let state = Array.from({length:81},()=>({text:"", color:""}));

  const grid=document.getElementById('grid');
  const drawer=document.getElementById('drawer');
  const cellIndexSpan=document.getElementById('cellIndex');
  const cellText=document.getElementById('cellText');
  const colorPicker=document.getElementById('colorPicker');
  const statusEl=document.getElementById('status');
  let editingIndex=null;

  const showStatus = (msg, isError=false)=>{
    statusEl.textContent = msg || "";
    statusEl.style.color = isError ? "#d9480f" : "#343a40";
  };

  const idx = (r,c)=> r*9 + c;
  const innerToOuter = new Map([
    [idx(3,3), idx(1,1)],
    [idx(3,4), idx(1,4)],
    [idx(3,5), idx(1,7)],
    [idx(4,5), idx(4,7)],
    [idx(5,5), idx(7,7)],
    [idx(5,4), idx(7,4)],
    [idx(5,3), idx(7,1)],
    [idx(4,3), idx(4,1)],
  ]);
  function syncOuterText(i){
    const j = innerToOuter.get(i);
    if (j==null) return;
    state[j].text = state[i].text || "";
  }

  function blockClass(i){
    const r=Math.floor(i/9),c=i%9;
    return 'b'+(Math.floor(r/3)*3+Math.floor(c/3));
  }
  const blockColors=["#fff0f0","#fff7db","#eefce9","#e8f9ff","#f3f3f3","#f2ecff","#fff3e6","#e8f2ff","#fde5f0"];

  const colors=["#ff6b6b","#ffa94d","#ffd43b","#69db7c","#4dabf7","#9775fa","#f783ac","#868e96","#20c997","#ffffff"];
  function buildColorPicker(){
    colorPicker.innerHTML = "";
    colors.forEach(c=>{
      const btn=document.createElement('div');
      btn.className='color-btn'; btn.style.background=c;
      btn.onclick=()=>{ if(editingIndex!=null){ state[editingIndex].color=c; render(); }};
      colorPicker.appendChild(btn);
    });
  }
  buildColorPicker();

  document.getElementById('clearColorBtn').onclick=()=>{
    if(editingIndex!=null){ state[editingIndex].color=""; render(); }
  };

  function render(){
    grid.innerHTML="";
    state.forEach((s,i)=>{
      const c=document.createElement('div');
      c.className='cell';
      const baseColor=blockColors[parseInt(blockClass(i).slice(1))];
      c.style.background= s.color || baseColor;
      const lab=document.createElement('div');
      lab.className='label'; lab.textContent=s.text||"";
      c.appendChild(lab);
      c.onclick=()=>openEditor(i);
      grid.appendChild(c);
    });
  }

  function openEditor(i){
    editingIndex=i; drawer.classList.add('open'); cellIndexSpan.textContent=i+1;
    cellText.value=state[i].text||"";
  }
  cellText.addEventListener('input', ()=>{
    if(editingIndex!=null){
      state[editingIndex].text = cellText.value;
      syncOuterText(editingIndex);
      render();
    }
  });
  document.getElementById('okBtn').onclick=()=>{
    if(editingIndex!=null){ state[editingIndex].text=cellText.value; render(); }
    drawer.classList.remove('open');
  };

  const norm = (s)=> (s||"").trim().toLowerCase();

  function genId(){
    const d = new Date();
    const pad = (n)=>String(n).padStart(2,'0');
    const id = `grid_${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}_${d.getTime()}`;
    return id;
    }

  async function save(){
    const idInput = document.getElementById('docId');
    let docId = (idInput.value||"").trim();
    if(!docId){
      docId = genId();
      idInput.value = docId;
    }
    meta.industry = norm(document.getElementById('industry').value);
    meta.chapter  = norm(document.getElementById('chapter').value);

    try{
      await setDoc(doc(db,"grids",docId),{meta,state});
      showStatus(`已存到 ${docId}`);
    }catch(e){
      console.error(e);
      showStatus(`存檔失敗：${e?.message||e}`, true);
    }
  }

  async function load(){
    const docId=(document.getElementById('docId').value||"").trim();
    if(!docId){ showStatus("請先輸入文件ID再載入。", true); return; }
    try{
      const snap=await getDoc(doc(db,"grids",docId));
      if(snap.exists()){
        const d=snap.data(); meta=d.meta||{industry:"",chapter:""}; state=d.state||state; render();
        document.getElementById('industry').value=meta.industry||"";
        document.getElementById('chapter').value=meta.chapter||"";
        showStatus(`已載入 ${docId}`);
      } else {
        showStatus(`找不到 ${docId}`, true);
      }
    }catch(e){
      console.error(e);
      showStatus(`載入失敗：${e?.message||e}`, true);
    }
  }

  async function search(){
    const ind=norm(document.getElementById('industry').value);
    const chap=norm(document.getElementById('chapter').value);
    if(!ind || !chap){ showStatus("搜尋前請同時輸入『行業別』與『分會』。", true); return; }

    try{
      const q=query(collection(db,"grids"),
                    where("meta.industry","==",ind),
                    where("meta.chapter","==",chap));
      const snap=await getDocs(q);
      if(snap.empty){ showStatus("找不到符合的頁面（請檢查行業別與分會是否完全一致）。", true); return; }
      const docSnap = snap.docs[0];
      const d = docSnap.data();
      meta=d.meta||{industry:"",chapter:""};
      state=d.state||state; render();
      document.getElementById('docId').value=docSnap.id;
      showStatus(`已載入 ${docSnap.id}`);
    }catch(e){
      console.error(e);
      showStatus(`搜尋失敗：${e?.message||e}`, true);
    }
  }

  document.getElementById('saveBtn').onclick=save;
  document.getElementById('loadBtn').onclick=load;
  document.getElementById('searchBtn').onclick=search;

  render();
</script>
</body>
</html>